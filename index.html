<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Bia e Guilherme</title>
<style>
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%;width:100%;background:#000;font-family:Arial,Helvetica,sans-serif;overflow:hidden}
  video#hiddenVideo{display:none}
  canvas#stage{
    position:absolute;top:0;left:0;width:100vw;height:100vh;background:#000;display:block;
    image-rendering:auto;
  }
  img#overlayImg{display:none}
  #controls{
    position:absolute;bottom:80px;left:0;right:0;display:flex;justify-content:center;gap:14px;z-index:50;
  }
  .btn{
    width:56px;height:56px;border-radius:50%;border:none;background:#fff;font-size:22px;
    display:flex;align-items:center;justify-content:center;box-shadow:0 3px 8px rgba(0,0,0,0.35);cursor:pointer;
    opacity:0.95;
  }
  .btn:active{transform:scale(0.98)}
  #recBtn.recording{background:#d32f2f;color:#fff}
  #previewModal{position:absolute;inset:0;background:rgba(0,0,0,0.88);display:none;align-items:center;justify-content:center;flex-direction:column;z-index:60;padding:18px}
  #previewImg{max-width:92vw;border:3px solid #fff;border-radius:8px}
  .action{margin-top:12px;padding:10px 18px;border-radius:8px;border:none;color:#fff;font-size:15px;cursor:pointer;width:200px}
  .save{background:#28a745}
  .retake{background:#ff5252}
  .saveVideo{background:#1e88e5}
  #notes{color:#fff;margin-top:12px;text-align:center;max-width:90%;font-size:14px;display:none}
</style>
</head>
<body>

<video id="hiddenVideo" autoplay playsinline muted></video>
<canvas id="stage"></canvas>
<img id="overlayImg" src="moldura.png" alt="moldura">

<div id="controls">
  <button id="switchBtn" class="btn" disabled>ðŸ”„</button>
  <button id="captureBtn" class="btn" disabled>ðŸ“¸</button>
  <button id="recBtn" class="btn" disabled>ðŸŽ¬</button>
</div>

<div id="previewModal">
  <img id="previewImg">
  <button id="savePhotoBtn" class="action save">Salvar Foto</button>
  <button id="saveVideoBtn" class="action saveVideo" style="display:none">Salvar VÃ­deo</button>
  <button id="retakeBtn" class="action retake">Fechar / Tirar outra</button>
  <div id="notes">iPhone: se o download nÃ£o iniciar, toque e segure e selecione "Salvar".</div>
</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.4/dist/ffmpeg.min.js"></script>

<script>
(async function(){
  const hiddenVideo = document.getElementById('hiddenVideo');
  const canvas = document.getElementById('stage');
  const ctx = canvas.getContext('2d', { alpha: false });
  const overlayImg = document.getElementById('overlayImg');

  const switchBtn = document.getElementById('switchBtn');
  const captureBtn = document.getElementById('captureBtn');
  const recBtn = document.getElementById('recBtn');

  const previewModal = document.getElementById('previewModal');
  const previewImg = document.getElementById('previewImg');
  const savePhotoBtn = document.getElementById('savePhotoBtn');
  const saveVideoBtn = document.getElementById('saveVideoBtn');
  const retakeBtn = document.getElementById('retakeBtn');
  const notes = document.getElementById('notes');

  let useFront = true;
  let cameraStream = null;
  let recording = false;
  let mediaRecorder = null;
  let recordedBlobs = [];
  let canvasStream = null;
  let micStream = null;

  /* ---------- CONFIG RESOLUÃ‡ÃƒO ---------- */
  const constraintsBase = {
    video: { width:{ ideal:1280 }, height:{ ideal:720 }, frameRate:{ ideal:30, min:24 } },
    audio: false
  };

  /* ---------- INICIAR CÃ‚MERA (COM FALLBACK SAFARI) ---------- */
  async function startCamera(){
    stopCameraTracks();

    const constraints = JSON.parse(JSON.stringify(constraintsBase));
    constraints.video.facingMode = { exact: useFront ? 'user':'environment' };

    try {
      cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
    } catch {
      constraints.video.facingMode = useFront ? 'user' : 'environment';
      cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
    }

    hiddenVideo.srcObject = cameraStream;
    await hiddenVideo.play();

    const track = cameraStream.getVideoTracks()[0];
    const settings = track.getSettings();
    canvas.width = settings.width || 1280;
    canvas.height = settings.height || 720;

    requestAnimationFrame(drawLoop);
  }

  function stopCameraTracks(){
    if(cameraStream){
      cameraStream.getTracks().forEach(t => t.stop());
      cameraStream = null;
    }
  }

  /* ---------- LOOP DE DESENHO ---------- */
  function drawLoop(){
    if(!hiddenVideo || hiddenVideo.readyState < 2) return requestAnimationFrame(drawLoop);
    drawFrame();
    requestAnimationFrame(drawLoop);
  }

  function drawFrame(){
    const cw = canvas.width, ch = canvas.height;
    const vw = hiddenVideo.videoWidth, vh = hiddenVideo.videoHeight;
    const scale = Math.max(cw / vw, ch / vh);
    const sw = vw * scale, sh = vh * scale;
    const sx = (cw - sw) / 2, sy = (ch - sh) / 2;

    ctx.clearRect(0,0,cw,ch);
    if(useFront){ ctx.save(); ctx.translate(cw,0); ctx.scale(-1,1); ctx.drawImage(hiddenVideo, sx, sy, sw, sh); ctx.restore(); }
    else ctx.drawImage(hiddenVideo, sx, sy, sw, sh);

    if(overlayImg.complete){
      const ow = overlayImg.naturalWidth, oh = overlayImg.naturalHeight;
      const r = Math.min(cw/ow, ch/oh);
      const dw = ow*r, dh = oh*r;
      ctx.drawImage(overlayImg, (cw-dw)/2, (ch-dh)/2, dw, dh);
    }
  }

  /* ---------- FOTO ---------- */
  captureBtn.onclick = () => {
    previewImg.src = canvas.toDataURL("image/png");
    saveVideoBtn.style.display = "none";
    previewModal.style.display = "flex";
    notes.style.display = isIOS() ? "block":"none";
  };

  savePhotoBtn.onclick = () => downloadFile(previewImg.src, "foto-moldura.png");

  /* ---------- VÃDEO COM ÃUDIO ---------- */
  recBtn.onclick = () => recording ? stopRecording() : startRecording();

  async function startRecording(){
    try { micStream = await navigator.mediaDevices.getUserMedia({audio:true}); } catch { micStream = null; }

    canvasStream = canvas.captureStream(30);

    const combined = new MediaStream();
    canvasStream.getVideoTracks().forEach(t => combined.addTrack(t));
    micStream?.getAudioTracks().forEach(t => combined.addTrack(t));

    recordedBlobs = [];
    mediaRecorder = new MediaRecorder(combined, {mimeType:"video/webm"});
    mediaRecorder.ondataavailable = e => e.data.size && recordedBlobs.push(e.data);
    mediaRecorder.onstop = convertToMP4;

    mediaRecorder.start();
    recording = true;
    recBtn.classList.add("recording");
    recBtn.textContent = "â¹";
  }

  function stopRecording(){ mediaRecorder?.stop(); }

  async function convertToMP4(){
    recording = false; recBtn.classList.remove("recording"); recBtn.textContent = "ðŸŽ¬";
    micStream?.getTracks().forEach(t=>t.stop()); canvasStream?.getTracks().forEach(t=>t.stop());

    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log:false });
    await ffmpeg.load();

    const blob = new Blob(recordedBlobs, {type:"video/webm"});
    ffmpeg.FS("writeFile","i.webm", await fetchFile(blob));
    await ffmpeg.run("-i","i.webm","-c:v","libx264","-c:a","aac","-b:a","128k","out.mp4");
    const data = ffmpeg.FS("readFile","out.mp4");

    const url = URL.createObjectURL(new Blob([data.buffer],{type:"video/mp4"}));
    previewImg.src = canvas.toDataURL("image/png");
    previewModal.style.display = "flex";
    saveVideoBtn.style.display = "inline-block";
    saveVideoBtn.onclick = ()=> downloadFile(url,"video-moldura.mp4");
    notes.style.display = isIOS() ? "block":"none";
  }

  /* ---------- UTIL ---------- */
  function downloadFile(url,name){
    const a = document.createElement("a"); a.href=url; a.download=name; a.click();
  }
  function isIOS(){ return /iPhone|iPad|iPod/i.test(navigator.userAgent); }
  retakeBtn.onclick = ()=> previewModal.style.display="none";
  switchBtn.onclick = ()=> (useFront=!useFront, startCamera());

  /* ---------- DESBLOQUEAR BOTÃ•ES APÃ“S MOLDURA ---------- */
  overlayImg.onload = ()=>{
    switchBtn.disabled = captureBtn.disabled = recBtn.disabled = false;
  };

  await startCamera();
})();
</script>
</body>
</html>
